<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Network Tool - 智能网络工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/monitor.js') }}"></script>
    <script src="{{ url_for('static', filename='js/traffic-blackhole.js') }}"></script>
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
    
    <!-- 模块初始化脚本 -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('页面加载完成，初始化模块...');
        
        // 初始化配置模块
        if (typeof ConfigModule !== 'undefined') {
            console.log('初始化ConfigModule...');
            ConfigModule.init();
            ConfigModule.loadDefaultValues();
        } else {
            console.error('ConfigModule未定义');
        }
        
        // 初始化流量黑洞模块
        if (typeof TrafficBlackHoleModule !== 'undefined') {
            console.log('初始化TrafficBlackHoleModule...');
            setTimeout(() => {
                TrafficBlackHoleModule.init();
            }, 100);
        } else {
            console.error('TrafficBlackHoleModule未定义');
        }
        
        console.log('模块初始化完成');
    });
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-network-wired"></i> Smart Network Tool</h1>
            <p>网卡流量监测 + 流量黑洞服务 - 一体化管理</p>
        </header>
        
        <!-- 删除 onclick，添加 data-tab -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="monitor">
                <i class="fas fa-chart-line"></i> 流量监测
            </button>
            <button class="tab-btn" data-tab="downonly">
                <i class="fas fa-cloud-download-alt"></i> 流量黑洞
            </button>
        </div>
        
        <!-- 流量监测 Tab -->
        <div id="monitor-tab" class="tab-content active">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-ethernet"></i> 网卡选择
                </div>
                <div class="control-panel">
                    <div class="select-wrapper">
                        <!-- 删除 onchange -->
                        <select id="interface-select" class="interface-select">
                            {% for interface in interfaces %}
                            <option value="{{ interface }}">{{ interface }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="interface-info">
                        <div class="interface-help">
                            <i class="fas fa-info-circle"></i>
                            <span class="interface-description">enp2s0: 主网络接口 (连接到主路由)</span>
                        </div>
                        <span id="current-interface-display" class="status-indicator status-running">
                            <i class="fas fa-circle"></i> <span id="interface-name">{{ interfaces[0] if interfaces else '无网卡' }}</span>
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-upload" style="color: #3b82f6;"></i></div>
                    <div class="stat-value" id="total-sent">0.00</div>
                    <div class="stat-label">总发送 (MB)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-download" style="color: #10b981;"></i></div>
                    <div class="stat-value" id="total-recv">0.00</div>
                    <div class="stat-label">总接收 (MB)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-arrow-up" style="color: #f59e0b;"></i></div>
                    <div class="stat-value" id="sent-rate">0.00</div>
                    <div class="stat-label">发送速率 (KB/s)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-arrow-down" style="color: #8b5cf6;"></i></div>
                    <div class="stat-value" id="recv-rate">0.00</div>
                    <div class="stat-label">接收速率 (KB/s)</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title"><i class="fas fa-chart-area"></i> 实时流量曲线</div>
                <div id="monitor-chart" class="chart-container"></div>
            </div>
        </div>
        
        <!-- 流量黑洞 Tab -->
        <div id="downonly-tab" class="tab-content">
            <div class="card">
                <div class="card-title"><i class="fas fa-blackhole"></i> 流量黑洞控制</div>
                <div class="control-panel">
                    <!-- 删除 onclick -->
                    <button id="toggleDownOnly" class="btn btn-success" onclick="TrafficBlackHoleModule.toggleService()">
                        <i class="fas fa-play"></i> 启动流量黑洞
                    </button>
                    <span id="downonlyStatus" class="status-indicator status-stopped">
                        <i class="fas fa-circle"></i> 已停止
                    </span>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-tachometer-alt" style="color: #3b82f6;"></i></div>
                    <div class="stat-value" id="currentSpeed">0.00</div>
                    <div class="stat-label">当前速度 (KB/s)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-database" style="color: #10b981;"></i></div>
                    <div class="stat-value" id="todayUsage">0.00</div>
                    <div class="stat-label">今日消耗</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-flag-checkered" style="color: #f59e0b;"></i></div>
                    <div class="stat-value">
                        <input type="number" id="daily-quota-input" value="150" min="1" style="width: 80px; text-align: center;" data-user-modified="false">
                    </div>
                    <div class="stat-label">今日配额 (GB)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-clock" style="color: #8b5cf6;"></i></div>
                    <div class="stat-value" id="uptimeSeconds">00:00:00</div>
                    <div class="stat-label">运行时间</div>
                </div>
            </div>
            
            <!-- 配置表单移动到流量黑洞页面 -->
            <div class="card">
                <div class="card-title"><i class="fas fa-sliders-h"></i> 流量黑洞配置</div>
                <form id="config-form">
                    <div class="config-form">
                        <div class="form-group">
                            <label>限速 (Mbps)</label>
                            <input type="number" id="speed-limit" value="10" min="1" max="1000">
                        </div>
                        <div class="form-group">
                            <label>每日最小配额 (GB)</label>
                            <input type="number" id="daily-quota-min" value="100" min="1">
                        </div>
                        <div class="form-group">
                            <label>每日最大配额 (GB)</label>
                            <input type="number" id="daily-quota-max" value="200" min="1">
                        </div>
                        <div class="form-group">
                            <label>开始时间 (HH:MM)</label>
                            <input type="text" id="schedule-start" value="00:00" pattern="[0-9]{2}:[0-9]{2}">
                        </div>
                        <div class="form-group">
                            <label>结束时间 (HH:MM)</label>
                            <input type="text" id="schedule-end" value="23:59" pattern="[0-9]{2}:[0-9]{2}">
                        </div>
                        <div class="form-group">
                            <label>最小休息 (分钟)</label>
                            <input type="number" id="sleep-min" value="10" min="1">
                        </div>
                        <div class="form-group">
                            <label>最大休息 (分钟)</label>
                            <input type="number" id="sleep-max" value="20" min="1">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label>下载地址</label>
                        <input type="url" id="url-input" placeholder="请输入下载URL" class="url-input">
                        <div style="margin-top: 10px;">
                            <label>
                                <input type="checkbox" id="cycle-download"> 循环下载所有源
                            </label>
                        </div>
                        <div id="url-list" style="margin-top: 10px;">
                            <!-- URL列表和添加按钮将通过JavaScript动态生成 -->
                        </div>
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button type="button" id="save-config-btn" class="btn btn-primary">
                            <i class="fas fa-save"></i> 保存配置
                        </button>
                        <button type="button" id="reset-config-btn" class="btn btn-secondary">
                            <i class="fas fa-undo"></i> 恢复默认
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 内联事件绑定（确保在模块加载后执行） -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Inline binding starting...');
        
        // Tab 切换
        document.querySelectorAll('.tab-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var tab = this.getAttribute('data-tab');
                console.log('Tab clicked:', tab);
                
                // 切换内容
                document.querySelectorAll('.tab-content').forEach(function(el) {
                    el.classList.remove('active');
                });
                document.getElementById(tab + '-tab').classList.add('active');
                
                // 切换按钮样式
                document.querySelectorAll('.tab-btn').forEach(function(el) {
                    el.classList.remove('active');
                });
                this.classList.add('active');
                
                // 调整图表大小
                setTimeout(function() {
                    if (typeof MonitorModule !== 'undefined') MonitorModule.resize();
                    if (typeof TrafficBlackHoleModule !== 'undefined') TrafficBlackHoleModule.resize();
                }, 100);
            });
        });
        
        // 网卡选择
        var interfaceSelect = document.getElementById('interface-select');
        if (interfaceSelect) {
            interfaceSelect.addEventListener('change', function() {
                if (typeof MonitorModule !== 'undefined') {
                    MonitorModule.changeInterface();
                }
            });
        }
        
        // 配置表单提交处理 - 重要修复
        var configForm = document.getElementById('config-form');
        if (configForm) {
            configForm.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('配置表单提交被阻止');
                
                // 使用ConfigModule的save方法
                if (typeof ConfigModule !== 'undefined') {
                    ConfigModule.save();
                }
                
                return false;
            });
            
            // 保存按钮事件
            var saveBtn = document.getElementById('save-config-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('保存按钮点击被阻止');
                    
                    // 使用ConfigModule的save方法
                    if (typeof ConfigModule !== 'undefined') {
                        ConfigModule.save();
                    }
                });
            }
            
            // 恢复默认按钮事件
            var resetBtn = document.getElementById('reset-config-btn');
            if (resetBtn) {
                resetBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('恢复默认按钮点击被阻止');
                    
                    // 使用ConfigModule的reset方法
                    if (typeof ConfigModule !== 'undefined') {
                        ConfigModule.resetToDefault();
                    }
                });
            }
            
            // 添加URL按钮事件
            var addUrlBtn = document.getElementById('add-url-btn');
            if (addUrlBtn) {
                addUrlBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('添加URL按钮点击被阻止');
                    
                    // 使用ConfigModule的addURL方法
                    if (typeof ConfigModule !== 'undefined') {
                        ConfigModule.addURL();
                    }
                });
            }
        }
        
        // 配额输入框修改检测
        var quotaInput = document.getElementById('daily-quota-input');
        if (quotaInput) {
            quotaInput.addEventListener('change', function() {
                this.dataset.userModified = 'true';
                console.log('用户修改了配额:', this.value);
                
                // 如果配额被修改，更新相关配置
                if (typeof ConfigModule !== 'undefined') {
                    ConfigModule.updateDailyQuota(this.value);
                }
            });
        }
        
        console.log('Inline binding completed');
    });
    </script>
</body>
</html>